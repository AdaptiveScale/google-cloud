
#### **Description**

Write to Datastore

#### **Properties**

Following are properties used to configure this plugin

* **Reference Name**

  Name used to uniquely identify this sink for lineage, annotating metadata, etc.

* **Namespace**

  Namespace of the entities to write. A namespace partitions entities into a subset of Cloud Datastore.
If no value is provided, the `[default]` namespace will be used. 

* **Kind**

  Kind of entities to write. Kinds are used to categorize entities in Cloud Datastore.
A kind is equivalent to the relational database table notion.

* **Key Type**

 Type of key assigned to entities written to the Cloud Datastore. The type can be one of four values:

   1. `Auto-generated key` - key will be generated by Cloud Datastore as a _Numeric ID_.
   2. `Custom name` - key will be provided as a field in the input records. The key field must not be nullable and must be
of type STRING, INT or LONG.
   3. `Key literal` - key will be provided as a field in the input records in key literal format. The key field type must be
a non-nullable string and the value must be in key literal format: 
`key(<kind>, <identifier>, <kind>, <identifier>, [...])`.
Example: `key(kind_name, 'stringId')`
   4. `URL-safe key` - key will be provided as a field in the input records in encoded URL form. The key field type must be
a non-nullable string and the value must be a URL-safe string.

* **Key Alias**

  The field that will be used as the entity key when writing to Cloud Datastore. This must be provided
when the Key Type is not auto generated. 

* **Ancestor**

  Ancestor identifies the common root entity in which the entities are grouped.
An ancestor must be specified in key literal format: `key(<kind>, <identifier>, <kind>, <identifier>, [...])`.
Example: `key(kind_1, 'stringId', kind_2, 100)` 

* **Index Strategy**

  Defines which fields will be indexed in Cloud Datastore. Can be one of three options:

  1. `All` - all fields will be indexed
  2. `None` - none of fields will be indexed
  3. `Custom` - indexed fields will be provided in `Indexed Properties`

* **Indexed Properties**

  Fields to index in Cloud Datastore. A value must be provided if the `Index Strategy` is
`Custom`, otherwise it is ignored.

* **Batch Size**

  Maximum number of entities that can be passed in one batch to a Commit operation.
The minimum value is `1` and maximum value is `500`.

#### **Credentials**

If the plugin is run in GCP environment, the service account file path does not need to be
specified and can be set to 'auto-detect'. Credentials will be automatically read from the GCP environment.
A path to a service account key must be provided when not running in GCP. The service account
key can be found on the Dashboard in the Cloud Platform Console. Ensure that the account key has permission
to access resource.

* **Project Id**

  Google Cloud Project Id, which uniquely identifies a project.
It can be found on the Dashboard in the Google Cloud Platform Console.

* **Service Account File Path**

  Path on the local file system of the service account key used for
authorization. Can be set to 'auto-detect' when running in GCP. When running on outside GCP,
the file must be present on every node were pipeline runs.

#### **Example**

***Example 1:*** Insert new entities with key type `Auto-generated key` to Cloud Datastore.

*Initial state for `Namespace: sample-ns`, `Kind: User`*

***No records.***

*Input Dataset*

    +----------+-----------+
    | lastName |  company  |
    +----------+-----------+
    | Smith    | Apple     |
    | Jones    | Google    |
    | Miller   | Microsoft |
    +----------+-----------+

*Sink Properties*

    +-----------+--------------------+
    |   Name    |       Value        |
    +-----------+--------------------+
    | Project   | sample-project     |
    | Namespace | sample-ns          |
    | Kind      | User               |
    | Key Type  | Auto-generated key |
    +-----------+--------------------+

*Input Schema*

    +----------+--------+
    |   Name   |  Type  |
    +----------+--------+
    | lastName | STRING |
    | company  | STRING |
    +----------+--------+

*Output in Cloud Datastore `Namespace: sample-ns`, `Kind: User`*

    +---------------------+----------+-----------+
    |       Name/ID       | lastName |  company  |
    +---------------------+----------+-----------+
    | id=4505323922522112 | Smith    | Apple     |
    | id=4505323922522113 | Jones    | Google    |
    | id=4505323922522114 | Miller   | Microsoft |
    +---------------------+----------+-----------+

***Example 2:*** Insert new entities with `Ancestor` and key type `Custom name` to Cloud Datastore.

*Initial state for `Namespace: sample-ns`, `Kind: User`*

***No records.***

*Input Dataset*

    +----------+----------+-----------+
    |   key    | lastName |  company  |
    +----------+----------+-----------+
    | user-100 | Smith    | Apple     |
    | user-101 | Jones    | Google    |
    | user-102 | Miller   | Microsoft |
    +----------+----------+-----------+

*Sink Properties*

    +-----------+---------------------+
    |   Name    |        Value        |
    +-----------+---------------------+
    | Project   | sample-project      |
    | Namespace | sample-ns           |
    | Kind      | User                |
    | Ancestor  | Key(Country, 'USA') |
    | Key Type  | Custom name         |
    | Key Alias | key                 |
    +-----------+---------------------+

*Input Schema*

    +----------+--------+
    |   Name   |  Type  |
    +----------+--------+
    | key      | STRING |
    | lastName | STRING |
    | company  | STRING |
    +----------+--------+

*Output in Cloud Datastore `Namespace: sample-ns`, `Kind: User`*

    +---------------+---------------------+----------+-----------+
    |    Name/ID    |       Parent        | lastName |  company  |
    +---------------+---------------------+----------+-----------+
    | name=user-100 | Key(Country, 'USA') | Smith    | Apple     |
    | name=user-101 | Key(Country, 'USA') | Jones    | Google    |
    | name=user-102 | Key(Country, 'USA') | Miller   | Microsoft |
    +---------------+---------------------+----------+-----------+

***Example 3:*** Upsert entities with new field `isContractor` and key type `Key literal` to Cloud Datastore.

*Initial state for `Namespace: sample-ns`, `Kind: User`*

    +---------+---------------------+----------+---------+
    | Name/ID |       Parent        | lastName | company |
    +---------+---------------------+----------+---------+
    | id=1    | Key(Country, 'USA') | Smith    | Apple   |
    | id=2    | Key(Country, 'USA') | Jones    | Google  |
    +---------+---------------------+----------+---------+

*Input Dataset*

    +------------------------------+----------+---------+--------------+
    |             key              | lastName | company | isContractor |
    +------------------------------+----------+---------+--------------+
    | Key(Country, 'USA', User, 1) | Smith    | Netflix | true         |
    | Key(User, 3)                 | Miller   | Google  | false        |
    +------------------------------+----------+---------+--------------+

*Sink Properties*

    +-----------+----------------+
    |   Name    |     Value      |
    +-----------+----------------+
    | Project   | sample-project |
    | Namespace | sample-ns      |
    | Kind      | User           |
    | Key Type  | Key literal    |
    | Key Alias | key            |
    +-----------+----------------+

*Input Schema*

    +--------------+---------+
    |     Name     |  Type   |
    +--------------+---------+
    | key          | STRING  |
    | lastName     | STRING  |
    | company      | STRING  |
    | isContractor | BOOLEAN |
    +--------------+---------+

*Output in Cloud Datastore `Namespace: sample-ns`, `Kind: User`*

    +---------+---------------------+----------+---------+--------------+
    | Name/ID |       Parent        | lastName | company | isContractor |
    +---------+---------------------+----------+---------+--------------+
    | id=1    | Key(Country, 'USA') | Smith    | Netflix | true         |
    | id=2    | Key(Country, 'USA') | Jones    | Google  | -            |
    | id=3    | -                   | Miller   | Google  | false        |
    +---------+---------------------+----------+---------+--------------+

***Example 4:*** Update entities values without `Key alias` using key type `URL-safe key` in Cloud Datastore.

*Initial state for `Namespace: sample-ns`, `Kind: User`*

    +---------------+----------+---------+--------------+
    |    Name/ID    | lastName | company | isContractor |
    +---------------+----------+---------+--------------+
    | name=user-100 | Smith    | Netflix | true         |
    | name=user-101 | Jones    | Google  | -            |
    | name=user-102 | Miller   | Google  | false        |
    +---------------+----------+---------+--------------+

*Input Dataset*

    +--------------------------------------------------------------------+----------+---------+--------------+
    |                              __key__                               | lastName | company | isContractor |
    +--------------------------------------------------------------------+----------+---------+--------------+
    | partition_id+%7B%0Aproject_id%3A+%22sample-project% … user-100%22% | Smith    | Netflix | false        |
    | partition_id+%7B%0Aproject_id%3A+%22sample-project% … user-101%22% | Jones    | Google  | false        |
    | partition_id+%7B%0Aproject_id%3A+%22sample-project% … user-102%22% | Miller   | Apple   | true         |
    +--------------------------------------------------------------------+----------+---------+--------------+

*Sink Properties*

    +-----------+----------------+
    |   Name    |     Value      |
    +-----------+----------------+
    | Project   | sample-project |
    | Namespace | sample-ns      |
    | Kind      | User           |
    | Key Type  | URL-safe key   |
    +-----------+----------------+

*Input Schema*

    +--------------+---------+
    |     Name     |  Type   |
    +--------------+---------+
    | __key__      | STRING  |
    | lastName     | STRING  |
    | company      | STRING  |
    | isContractor | BOOLEAN |
    +--------------+---------+

*Output in Cloud Datastore `Namespace: sample-ns`, `Kind: User`*

    +---------------+----------+---------+--------------+
    |    Name/ID    | lastName | company | isContractor |
    +---------------+----------+---------+--------------+
    | name=user-100 | Smith    | Netflix | false        |
    | name=user-101 | Jones    | Google  | false        |
    | name=user-102 | Miller   | Apple   | true         |
    +---------------+----------+---------+--------------+
